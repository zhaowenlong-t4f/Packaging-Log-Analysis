<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åç«¯APIæµ‹è¯•å·¥å…·</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 { color: #333; margin-bottom: 20px; }
        .config {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        .config input {
            width: 300px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .section {
            margin-bottom: 30px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 15px;
        }
        .section h2 {
            color: #555;
            margin-bottom: 15px;
            font-size: 18px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            color: #666;
            font-size: 14px;
        }
        input, textarea, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        textarea {
            min-height: 100px;
            font-family: monospace;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .response {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
            border-left: 4px solid #007bff;
        }
        .response h3 {
            font-size: 14px;
            margin-bottom: 10px;
            color: #333;
        }
        .response pre {
            background: #fff;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .error { border-left-color: #dc3545; }
        .success { border-left-color: #28a745; }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        @media (max-width: 768px) {
            .grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ åç«¯APIæµ‹è¯•å·¥å…·</h1>
        
        <!-- é…ç½® -->
        <div class="config">
            <label>APIåŸºç¡€åœ°å€ï¼š</label>
            <input type="text" id="baseUrl" value="http://localhost:3000/api/v1" placeholder="http://localhost:3000/api/v1">
        </div>

        <!-- å¥åº·æ£€æŸ¥ -->
        <div class="section">
            <h2>1. å¥åº·æ£€æŸ¥</h2>
            <button onclick="testHealth()">æµ‹è¯•å¥åº·æ£€æŸ¥</button>
            <div id="healthResponse"></div>
        </div>

        <!-- æ—¥å¿—åˆ†æ -->
        <div class="section">
            <h2>2. æ—¥å¿—åˆ†æ</h2>
            <div class="form-group">
                <label>ä¸Šä¼ ç±»å‹ï¼š</label>
                <select id="uploadType">
                    <option value="text">æ–‡æœ¬ (text)</option>
                    <option value="url">URL (url)</option>
                    <option value="file">æ–‡ä»¶ (file)</option>
                </select>
            </div>
            <div class="form-group">
                <label>æ—¥å¿—å†…å®¹ï¼š</label>
                <textarea id="logContent" placeholder='è¾“å…¥æ—¥å¿—å†…å®¹ï¼Œä¾‹å¦‚ï¼š\nError: Build failed\nWarning: Deprecated API'>Error: Build failed
Warning: Deprecated API usage
Info: Compilation started</textarea>
            </div>
            <div class="form-group">
                <label>æ–‡ä»¶åï¼š</label>
                <input type="text" id="fileName" value="test.log">
            </div>
            <div class="form-group">
                <label>å…ƒæ•°æ®ï¼ˆJSONï¼‰ï¼š</label>
                <textarea id="metadata" placeholder='{"projectName": "ProjectX", "buildVersion": "1.0.0", "platform": "Android"}'>{}</textarea>
            </div>
            <button onclick="testAnalyzeLog()">ä¸Šä¼ å¹¶åˆ†ææ—¥å¿—</button>
            <div id="analyzeResponse"></div>
        </div>

        <!-- è·å–åˆ†æè¯¦æƒ… -->
        <div class="section">
            <h2>3. è·å–åˆ†æè¯¦æƒ…</h2>
            <div class="form-group">
                <label>åˆ†æIDï¼š</label>
                <input type="text" id="analysisId" placeholder="ä»ä¸Šé¢çš„åˆ†æç»“æœä¸­è·å–">
            </div>
            <div class="grid">
                <div class="form-group">
                    <label>é¡µç ï¼š</label>
                    <input type="number" id="pageNo" value="1" min="1">
                </div>
                <div class="form-group">
                    <label>æ¯é¡µæ•°é‡ï¼š</label>
                    <input type="number" id="pageSize" value="20" min="1" max="100">
                </div>
            </div>
            <button onclick="testGetLogDetails()">è·å–è¯¦æƒ…</button>
            <div id="logDetailsResponse"></div>
        </div>

        <!-- è§„åˆ™ç®¡ç† -->
        <div class="section">
            <h2>4. è§„åˆ™ç®¡ç†</h2>
            
            <h3 style="margin-top: 15px; margin-bottom: 10px;">4.1 è·å–è§„åˆ™åˆ—è¡¨</h3>
            <div class="grid">
                <div class="form-group">
                    <label>é¡µç ï¼š</label>
                    <input type="number" id="rulePageNo" value="1" min="1">
                </div>
                <div class="form-group">
                    <label>æ¯é¡µæ•°é‡ï¼š</label>
                    <input type="number" id="rulePageSize" value="20" min="1" max="100">
                </div>
            </div>
            <button onclick="testGetRules()">è·å–è§„åˆ™åˆ—è¡¨</button>
            <div id="rulesResponse"></div>

            <h3 style="margin-top: 20px; margin-bottom: 10px;">4.2 åˆ›å»ºè§„åˆ™</h3>
            <div class="form-group">
                <label>è§„åˆ™åç§°ï¼š</label>
                <input type="text" id="ruleName" value="æµ‹è¯•è§„åˆ™">
            </div>
            <div class="form-group">
                <label>æ­£åˆ™è¡¨è¾¾å¼ï¼š</label>
                <input type="text" id="ruleRegex" value="error.*">
            </div>
            <div class="form-group">
                <label>å…³é”®è¯ï¼ˆJSONæ•°ç»„ï¼‰ï¼š</label>
                <input type="text" id="ruleKeywords" value='["error"]'>
            </div>
            <div class="form-group">
                <label>è§£å†³æ–¹æ¡ˆï¼ˆMarkdownï¼‰ï¼š</label>
                <textarea id="ruleSolution">æ£€æŸ¥é”™è¯¯æ—¥å¿—å¹¶ä¿®å¤é—®é¢˜</textarea>
            </div>
            <div class="grid">
                <div class="form-group">
                    <label>ä¸¥é‡ç¨‹åº¦ï¼š</label>
                    <select id="ruleSeverity">
                        <option value="ERROR">ERROR</option>
                        <option value="WARNING">WARNING</option>
                        <option value="INFO">INFO</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>æƒé‡ï¼š</label>
                    <input type="number" id="ruleWeight" value="50" min="0" max="100">
                </div>
            </div>
            <div class="form-group">
                <label>åˆ†ç±»ï¼ˆJSONæ•°ç»„ï¼‰ï¼š</label>
                <input type="text" id="ruleCategories" value='["compilation"]'>
            </div>
            <button onclick="testCreateRule()">åˆ›å»ºè§„åˆ™</button>
            <div id="createRuleResponse"></div>

            <h3 style="margin-top: 20px; margin-bottom: 10px;">4.3 è·å–å•ä¸ªè§„åˆ™</h3>
            <div class="form-group">
                <label>è§„åˆ™IDï¼š</label>
                <input type="text" id="getRuleId" placeholder="ä»è§„åˆ™åˆ—è¡¨ä¸­è·å–">
            </div>
            <button onclick="testGetRule()">è·å–è§„åˆ™</button>
            <div id="getRuleResponse"></div>

            <h3 style="margin-top: 20px; margin-bottom: 10px;">4.4 æ›´æ–°è§„åˆ™</h3>
            <div class="form-group">
                <label>è§„åˆ™IDï¼š</label>
                <input type="text" id="updateRuleId" placeholder="è¦æ›´æ–°çš„è§„åˆ™ID">
            </div>
            <div class="form-group">
                <label>æ–°è§„åˆ™åç§°ï¼š</label>
                <input type="text" id="updateRuleName" value="æ›´æ–°åçš„è§„åˆ™">
            </div>
            <button onclick="testUpdateRule()">æ›´æ–°è§„åˆ™</button>
            <div id="updateRuleResponse"></div>

            <h3 style="margin-top: 20px; margin-bottom: 10px;">4.5 åˆ é™¤è§„åˆ™</h3>
            <div class="form-group">
                <label>è§„åˆ™IDï¼š</label>
                <input type="text" id="deleteRuleId" placeholder="è¦åˆ é™¤çš„è§„åˆ™ID">
            </div>
            <button onclick="testDeleteRule()">åˆ é™¤è§„åˆ™</button>
            <div id="deleteRuleResponse"></div>
        </div>
    </div>

    <script>
        const baseUrl = () => document.getElementById('baseUrl').value;

        async function apiCall(method, url, body = null) {
            const options = {
                method,
                headers: { 'Content-Type': 'application/json' }
            };
            if (body) options.body = JSON.stringify(body);
            
            try {
                const response = await fetch(url, options);
                const data = await response.json();
                return { status: response.status, data };
            } catch (error) {
                return { status: 0, data: { error: error.message } };
            }
        }

        function showResponse(elementId, status, data) {
            const el = document.getElementById(elementId);
            const isSuccess = status >= 200 && status < 300;
            el.className = `response ${isSuccess ? 'success' : 'error'}`;
            el.innerHTML = `
                <h3>å“åº” (çŠ¶æ€ç : ${status})</h3>
                <pre>${JSON.stringify(data, null, 2)}</pre>
            `;
        }

        // 1. å¥åº·æ£€æŸ¥
        async function testHealth() {
            const response = await fetch(`${baseUrl().replace('/api/v1', '')}/health`);
            const data = await response.json();
            showResponse('healthResponse', response.status, data);
        }

        // 2. åˆ†ææ—¥å¿—
        async function testAnalyzeLog() {
            let metadata = {};
            try {
                metadata = JSON.parse(document.getElementById('metadata').value || '{}');
            } catch (e) {
                alert('å…ƒæ•°æ®JSONæ ¼å¼é”™è¯¯');
                return;
            }

            const body = {
                uploadType: document.getElementById('uploadType').value,
                content: document.getElementById('logContent').value,
                fileName: document.getElementById('fileName').value,
                metadata
            };

            const { status, data } = await apiCall('POST', `${baseUrl()}/logs/analyze`, body);
            showResponse('analyzeResponse', status, data);
            
            // è‡ªåŠ¨å¡«å……åˆ†æID
            if (data.data && data.data.analysisId) {
                document.getElementById('analysisId').value = data.data.analysisId;
            }
        }

        // 3. è·å–åˆ†æè¯¦æƒ…
        async function testGetLogDetails() {
            const analysisId = document.getElementById('analysisId').value;
            if (!analysisId) {
                alert('è¯·è¾“å…¥åˆ†æID');
                return;
            }

            const params = new URLSearchParams({
                pageNo: document.getElementById('pageNo').value,
                pageSize: document.getElementById('pageSize').value
            });

            const { status, data } = await apiCall('GET', `${baseUrl()}/logs/${analysisId}/details?${params}`);
            showResponse('logDetailsResponse', status, data);
        }

        // 4.1 è·å–è§„åˆ™åˆ—è¡¨
        async function testGetRules() {
            const params = new URLSearchParams({
                pageNo: document.getElementById('rulePageNo').value,
                pageSize: document.getElementById('rulePageSize').value
            });

            const { status, data } = await apiCall('GET', `${baseUrl()}/rules?${params}`);
            showResponse('rulesResponse', status, data);
        }

        // 4.2 åˆ›å»ºè§„åˆ™
        async function testCreateRule() {
            let keywords = [], categories = [];
            try {
                keywords = JSON.parse(document.getElementById('ruleKeywords').value || '[]');
                categories = JSON.parse(document.getElementById('ruleCategories').value || '[]');
            } catch (e) {
                alert('å…³é”®è¯æˆ–åˆ†ç±»JSONæ ¼å¼é”™è¯¯');
                return;
            }

            const body = {
                name: document.getElementById('ruleName').value,
                regex: document.getElementById('ruleRegex').value,
                keywords,
                solution: document.getElementById('ruleSolution').value,
                severity: document.getElementById('ruleSeverity').value,
                weight: parseInt(document.getElementById('ruleWeight').value),
                categories
            };

            const { status, data } = await apiCall('POST', `${baseUrl()}/rules`, body);
            showResponse('createRuleResponse', status, data);
            
            // è‡ªåŠ¨å¡«å……è§„åˆ™ID
            if (data.data && data.data.id) {
                document.getElementById('getRuleId').value = data.data.id;
                document.getElementById('updateRuleId').value = data.data.id;
            }
        }

        // 4.3 è·å–å•ä¸ªè§„åˆ™
        async function testGetRule() {
            const ruleId = document.getElementById('getRuleId').value;
            if (!ruleId) {
                alert('è¯·è¾“å…¥è§„åˆ™ID');
                return;
            }

            const { status, data } = await apiCall('GET', `${baseUrl()}/rules/${ruleId}`);
            showResponse('getRuleResponse', status, data);
        }

        // 4.4 æ›´æ–°è§„åˆ™
        async function testUpdateRule() {
            const ruleId = document.getElementById('updateRuleId').value;
            if (!ruleId) {
                alert('è¯·è¾“å…¥è§„åˆ™ID');
                return;
            }

            const body = {
                name: document.getElementById('updateRuleName').value
            };

            const { status, data } = await apiCall('PUT', `${baseUrl()}/rules/${ruleId}`, body);
            showResponse('updateRuleResponse', status, data);
        }

        // 4.5 åˆ é™¤è§„åˆ™
        async function testDeleteRule() {
            const ruleId = document.getElementById('deleteRuleId').value;
            if (!ruleId) {
                alert('è¯·è¾“å…¥è§„åˆ™ID');
                return;
            }

            if (!confirm(`ç¡®å®šè¦åˆ é™¤è§„åˆ™ ${ruleId} å—ï¼Ÿ`)) {
                return;
            }

            const { status, data } = await apiCall('DELETE', `${baseUrl()}/rules/${ruleId}`);
            showResponse('deleteRuleResponse', status, data);
        }
    </script>
</body>
</html>

