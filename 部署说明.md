# 一键部署说明

本项目提供了便捷的一键部署脚本，支持 Windows PowerShell 和批处理文件两种方式。

## 脚本说明

### 后端部署脚本

**位置**: `backend/deploy.ps1` 和 `backend/deploy.bat`

**功能**:
- ✅ 检查 Node.js 环境
- ✅ 自动安装依赖
- ✅ 生成 Prisma Client
- ✅ 构建 TypeScript 项目
- ✅ 启动服务

### 前端部署脚本

**位置**: `frontend/deploy.ps1` 和 `frontend/deploy.bat`

**功能**:
- ✅ 检查 Node.js 环境
- ✅ 检查环境变量配置
- ✅ 自动安装依赖
- ✅ 构建生产版本
- ✅ 启动预览服务器

### 全栈部署脚本

**位置**: `deploy-all.ps1`（仅 PowerShell）

**功能**:
- ✅ 同时部署前后端服务
- ✅ 自动获取本机 IP 地址
- ✅ 自动创建前端 .env 文件
- ✅ 在新窗口中启动服务

## 使用方法

### 方法一：PowerShell 脚本（推荐）

#### 单独部署后端

```powershell
# 进入后端目录
cd backend

# 完整部署
.\deploy.ps1

# 跳过依赖安装（如果已安装）
.\deploy.ps1 -SkipInstall

# 跳过构建（仅启动开发服务器）
.\deploy.ps1 -SkipBuild

# 生产模式
.\deploy.ps1 -Production
```

#### 单独部署前端

```powershell
# 进入前端目录
cd frontend

# 完整部署（构建后启动预览）
.\deploy.ps1 -Preview

# 仅构建，不启动
.\deploy.ps1

# 跳过依赖安装
.\deploy.ps1 -SkipInstall

# 跳过构建（启动开发服务器）
.\deploy.ps1 -SkipBuild
```

#### 一键部署所有服务

```powershell
# 在项目根目录运行
.\deploy-all.ps1

# 开发模式（不构建，直接启动开发服务器）
.\deploy-all.ps1 -Dev

# 生产模式
.\deploy-all.ps1 -Production
```

### 方法二：批处理文件（双击运行）

1. **后端部署**: 双击 `backend/deploy.bat`
2. **前端部署**: 双击 `frontend/deploy.bat`

批处理文件会自动执行完整部署流程。

## 参数说明

### 后端部署参数

| 参数 | 说明 |
|------|------|
| `-SkipInstall` | 跳过 npm install 步骤 |
| `-SkipBuild` | 跳过构建步骤，直接启动开发服务器 |
| `-SkipPrisma` | 跳过 Prisma Client 生成 |
| `-Production` | 生产模式（设置 NODE_ENV=production） |

### 前端部署参数

| 参数 | 说明 |
|------|------|
| `-SkipInstall` | 跳过 npm install 步骤 |
| `-SkipBuild` | 跳过构建步骤，直接启动开发服务器 |
| `-Preview` | 构建后启动预览服务器 |
| `-Production` | 生产模式构建 |

### 全栈部署参数

| 参数 | 说明 |
|------|------|
| `-SkipInstall` | 跳过依赖安装 |
| `-SkipBuild` | 跳过构建 |
| `-Production` | 生产模式 |
| `-Dev` | 开发模式（不构建，直接启动开发服务器） |
| `-Preview` | 前端预览模式（构建后启动预览服务器，默认启用） |

## 使用示例

### 示例 1：首次部署

```powershell
# 1. 部署后端
cd backend
.\deploy.ps1

# 2. 部署前端（新终端）
cd frontend
.\deploy.ps1 -Preview
```

### 示例 2：快速重启（已安装依赖）

```powershell
# 后端
cd backend
.\deploy.ps1 -SkipInstall

# 前端
cd frontend
.\deploy.ps1 -SkipInstall -Preview
```

### 示例 3：仅启动开发服务器（不构建）

```powershell
# 后端
cd backend
.\deploy.ps1 -SkipBuild

# 前端
cd frontend
.\deploy.ps1 -SkipBuild
```

### 示例 4：一键部署所有服务

```powershell
# 在项目根目录
.\deploy-all.ps1
```

这会：
1. 自动检测本机 IP 地址
2. 创建前端 .env 文件（如果不存在）
3. 在新窗口中启动后端服务
4. 在新窗口中启动前端服务

## 常见问题

### Q1: PowerShell 脚本无法运行

**错误**: "无法加载文件，因为在此系统上禁止运行脚本"

**解决方案**:
```powershell
# 以管理员身份运行 PowerShell，执行：
Set-ExecutionPolicy RemoteSigned -Scope CurrentUser
```

### Q1.1: PowerShell 脚本编码错误

**错误**: "字符串缺少终止符" 或中文字符显示为乱码

**解决方案**:

**方法一：运行修复脚本（推荐）**
```powershell
# 双击运行 fix-encoding.bat
# 或运行 PowerShell 脚本
.\fix-ps1-encoding.ps1
```

**方法二：手动修复**
```powershell
# 在 PowerShell 中运行以下命令修复所有脚本
$files = @("deploy-all.ps1", "backend\deploy.ps1", "frontend\deploy.ps1")
foreach ($file in $files) {
    $content = Get-Content $file -Raw
    $utf8 = New-Object System.Text.UTF8Encoding $true
    [System.IO.File]::WriteAllText((Resolve-Path $file), $content, $utf8)
}
```

**方法三：使用批处理文件（避免编码问题）**
- 使用 `backend\deploy.bat` 和 `frontend\deploy.bat` 代替 PowerShell 脚本

### Q2: 批处理文件中文乱码

**解决方案**: 批处理文件已设置 UTF-8 编码（`chcp 65001`），如果仍有问题，请使用 PowerShell 脚本。

### Q3: 端口被占用

**解决方案**:
- 修改 `backend/src/config/env.ts` 中的默认端口
- 或设置环境变量 `PORT=其他端口`
- 前端端口在 `frontend/vite.config.ts` 中修改

### Q4: Prisma 生成失败

**解决方案**:
```powershell
cd backend
npm run prisma:generate
```

如果仍有问题，检查 `prisma/schema.prisma` 文件是否正确。

### Q5: 构建失败

**解决方案**:
1. 检查 TypeScript 错误：`npm run lint`
2. 清理 node_modules 重新安装：`rm -r node_modules && npm install`
3. 检查 Node.js 版本是否符合要求（Node.js 18+）

## 生产环境部署建议

1. **使用生产模式构建**:
   ```powershell
   .\deploy.ps1 -Production
   ```

2. **配置环境变量**:
   - 创建 `.env` 文件
   - 设置 `NODE_ENV=production`
   - 配置数据库路径和其他参数

3. **使用进程管理器**:
   - 推荐使用 PM2: `npm install -g pm2`
   - 或使用 Windows 服务

4. **配置反向代理**:
   - 使用 Nginx 或 IIS
   - 配置 HTTPS
   - 设置静态文件服务

5. **监控和日志**:
   - 配置日志轮转
   - 设置监控告警
   - 定期备份数据库

## 注意事项

⚠️ **重要提示**:

1. 首次运行前请确保已安装 Node.js 18+ 和 npm
2. 部署脚本会自动安装依赖，可能需要一些时间
3. 生产环境部署前请仔细检查环境变量配置
4. 建议在测试环境先验证部署流程
5. 定期备份数据库文件（`backend/prisma/data/app.db`）

